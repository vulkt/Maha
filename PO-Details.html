<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PO Details - Purchase Order Management</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDwdlfBZWbNVFsj3ttfS9lcVJphIsFkKmA",
        authDomain: "tex1-e6595.firebaseapp.com",
        projectId: "tex1-e6595",
        storageBucket: "tex1-e6595.firebasestorage.app",
        messagingSenderId: "535507700855",
        appId: "1:535507700855:web:68f395bb2b3f7df52f4a72",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function loadPODetails() {
        const poNumber = localStorage.getItem("selectedPONumber");
        if (!poNumber) {
          alert("No PO number found in storage!");
          return;
        }

        // Try LC-PO first, then TT-PO
        let poDocRef = doc(db, "maha/PO/LC-PO", poNumber);
        let poSnap = await getDoc(poDocRef);

        if (!poSnap.exists()) {
          poDocRef = doc(db, "maha/PO/TT-PO", poNumber);
          poSnap = await getDoc(poDocRef);
        }

        if (!poSnap.exists()) {
          alert("PO not found in Firestore");
          return;
        }

        const poData = poSnap.data();

        // Fill General Information section
        document.getElementById("poNumber").innerText = poData["PO-NO"] || poNumber;
        document.getElementById("issueDate").innerText = formatDate(poData["Issue-Date"]);
        document.getElementById("downPayment").innerText = formatCurrency(poData["Down-Payment"]);
        document.getElementById("poValue").innerText = formatCurrency(poData["PO-Value"]);
        document.getElementById("lcNumber").innerText = poData["LC-NO"] || "—";
        document.getElementById("productionPeriod").innerText = poData["Production-Period"] ? `${poData["Production-Period"]} days` : "—";
        document.getElementById("deliveryDate").innerText = formatDate(poData["Delivery-Date"]);

        // Load Shipments
        const tbody = document.getElementById("shipmentTableBody");
        tbody.innerHTML = "";
        let totalExpected = 0;

        if (poData.shipments && Array.isArray(poData.shipments)) {
          poData.shipments.forEach((s, index) => {
            totalExpected += s["Expected-Amount"] || 0;

            const row = document.createElement("tr");
            row.className = "hover:bg-gray-50 transition-colors cursor-pointer";

            // Make the row clickable
            row.onclick = () => {
              localStorage.setItem("selectedShipment", JSON.stringify(s));
              window.location.href = "Shipment.html";
            };

            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-black">
                ${s["Shipment-Date"] ? new Date(s["Shipment-Date"].seconds * 1000).toLocaleDateString() : "—"}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${s["Payment-Terms"] || "—"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${s["Status"] || "—"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-black">${s["Expected-Amount"] !== undefined ? s["Expected-Amount"].toFixed(2) : "—"}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-black">${s["Expected-Date"] ? new Date(s["Expected-Date"].seconds * 1000).toLocaleDateString() : "—"}</td>
            `;
            tbody.appendChild(row);
          });

          document.getElementById("shipmentCount").innerText = `Showing ${poData.shipments.length} shipments`;
          document.getElementById("totalInvoice").innerText = `Total Expected: ${totalExpected.toFixed(2)}`;
        } else {
          tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No shipments found</td></tr>`;
          document.getElementById("shipmentCount").innerText = "No shipments";
          document.getElementById("totalInvoice").innerText = "—";
        }
      }

      function formatDate(value) {
        if (!value) return "—";
        try {
          let date = value.toDate ? value.toDate() : new Date(value);
          return date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
        } catch {
          return "—";
        }
      }

      function formatCurrency(value) {
        if (!value) return "—";
        return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(value);
      }

      document.addEventListener("DOMContentLoaded", loadPODetails);
    </script>
  </head>
  <body class="bg-white min-h-screen">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
          <button onclick="window.history.back()" class="flex items-center justify-center w-10 h-10 text-gray-600 hover:text-primary transition-colors">←</button>
          <h1 class="text-2xl font-bold text-black">Purchase Order Details</h1>
        </div>
      </div>

      <div class="space-y-8">
        <!-- General Information -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-black">General Information</h2>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">PO Number</label>
                  <div id="poNumber" class="text-lg font-semibold text-black">—</div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">PO Date</label>
                  <div id="issueDate" class="text-black">—</div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Down Payment</label>
                  <div id="downPayment" class="text-black font-medium">—</div>
                </div>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">PO Value</label>
                  <div id="poValue" class="text-lg font-semibold text-primary">—</div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">LC Number</label>
                  <div id="lcNumber" class="text-black">—</div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Production Period</label>
                  <div id="productionPeriod" class="text-black">—</div>
                </div>
              </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Delivery Date</label>
                <div id="deliveryDate" class="text-black font-medium">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Shipments -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
          <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-black">Shipment & Payment Details</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Shipment Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Payment Terms</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Expected Amount</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Expected Payment Date</th>
                </tr>
              </thead>
              <tbody id="shipmentTableBody" class="bg-white divide-y divide-gray-200">
                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="bg-gray-50 px-6 py-3 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div id="shipmentCount" class="text-sm text-gray-600">—</div>
              <div id="totalInvoice" class="text-sm font-medium text-black">—</div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end items-center pt-6">
          <div class="flex gap-3">
            <button class="px-6 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors !rounded-button whitespace-nowrap">
              Export PDF
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
